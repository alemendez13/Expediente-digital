<!--
  Componente: Antecedentes Personales Patológicos
  Descripción: Muestra la Subsección 1: Enfermedades Crónico Degenerativas.
  Utiliza un script para generar dinámicamente una estructura compleja de acordeones anidados,
  permitiendo un registro detallado de padecimientos por sistema y cuestionarios específicos.
-->

<!-- Funciones de Javascript para la interactividad de los acordeones -->
<script>
  // Función genérica para abrir/cerrar un acordeón.
  function toggleAccordion(headerElement) {
    const content = headerElement.nextElementSibling;
    const icon = headerElement.querySelector('svg');
    if (content) {
      content.classList.toggle('hidden');
    }
    if (icon) {
      icon.classList.toggle('rotate-180');
    }
  }

  // Función para mostrar/ocultar los detalles de una enfermedad al marcar/desmarcar el checkbox.
  function toggleContent(checkboxElement) {
    // Busca el contenedor de detalles más cercano dentro de la fila de la enfermedad.
    const detailsContainer = checkboxElement.closest('.disease-row').querySelector('.disease-details');
    if (detailsContainer) {
      detailsContainer.classList.toggle('hidden', !checkboxElement.checked);
    }
  }
</script>

<!-- Subsección 1: Enfermedades Crónico Degenerativas -->
<div class="p-4 border rounded-lg mb-4 bg-white text-sm">
  <h3 class="subsection-title">Enfermedades Crónico Degenerativas</h3>
  <p class="text-xs text-gray-500 mb-4">Seleccione los sistemas y enfermedades correspondientes para registrar los detalles.</p>
  
  <!-- Contenedor para los acordeones generados por script -->
  <div id="chronic-diseases-container" class="space-y-2"></div>
</div>

<!-- Script que construye la estructura HTML de la subsección -->
<script>
  // Objeto de configuración que define la estructura de sistemas, enfermedades y cuestionarios.
  // Fiel al documento "Datos para construir componentes.pdf".
  const chronicDiseasesConfig = [
    {
      name: 'Metabólicas', id: 'metabolicas', diseases: [
        { name: 'Diabetes', id: 'diabetes', questionnaire: 'paid' },
        { name: 'Dislipidemia', id: 'dislipidemia', subDiseases: ['Hipertrigliceridemia', 'Hipercolesterolemia'] },
        { name: 'Problemas de peso', id: 'problemas_peso' },
        { name: 'Otras', id: 'metabolicas_otras', isOther: true },
      ]
    },
    {
      name: 'Sistema Cardiovascular', id: 'cardiovascular', diseases: [
        { name: 'Hipertensión arterial', id: 'hta' },
        { name: 'Insuficiencia cardiaca', id: 'insuf_cardiaca' },
        { name: 'Insuficiencia venosa periférica', id: 'ivp' },
        { name: 'Valvulopatías', id: 'valvulopatias' },
        { name: 'Otras', id: 'cardio_otras', isOther: true },
      ]
    },
    {
      name: 'Sistema Digestivo', id: 'digestivo', diseases: [
        { name: 'Enfermedad por Reflujo', id: 'erge' },
        { name: 'Enfermedad ácido-péptica', id: 'eap' },
        { name: 'Síndrome de intestino irritable', id: 'sii', questionnaire: 'ibss' },
        { name: 'Otras', id: 'digestivo_otras', isOther: true },
      ]
    },
    {
      name: 'Sistema Respiratorio', id: 'respiratorio', diseases: [
        { name: 'Asma', id: 'asma' },
        { name: 'EPOC', id: 'epoc' },
        { name: 'Otras', id: 'resp_otras', isOther: true },
      ]
    },
    {
      name: 'Sistema Musculoesquelético', id: 'musculoesqueletico', diseases: [
        { name: 'Osteoartritis', id: 'osteoartritis' },
        { name: 'Osteoporosis', id: 'osteoporosis' },
        { name: 'Dolor crónico', id: 'dolor_cronico' },
        { name: 'Otras', id: 'musc_otras', isOther: true },
      ]
    },
    {
      name: 'Sistema Genitourinario', id: 'genitourinario', diseases: [
        { name: 'Especificar', id: 'genito_otras', isOther: true },
      ]
    },
    {
      name: 'Sistema Neurológico', id: 'neurologico', diseases: [
        { name: 'Psiquiátricas', id: 'psiquiatricas', questionnaire: 'psq' },
        { name: 'Otras', id: 'neuro_otras', isOther: true },
      ]
    },
    {
      name: 'Otras Enfermedades Relevantes', id: 'otras_enfermedades', diseases: [
        { name: 'Tumores o cáncer', id: 'cancer' },
        { name: 'Dermatológicas', id: 'dermatologicas' },
        { name: 'Problemas dentales', id: 'dentales', isOther: true },
        { name: 'Problemas ópticos', id: 'opticos', isOther: true },
        { name: 'Problemas auditivos', id: 'auditivos', isOther: true },
        { name: 'Atopias (alergias)', id: 'atopias', isOther: true },
        { name: 'Hiperuricemia', id: 'hiperuricemia' },
      ]
    }
  ];

  const container = document.getElementById('chronic-diseases-container');
  let html = '';

  // --- HTML para los Cuestionarios (se definen aquí para mayor claridad) ---

  const questionnairesHTML = {
    paid: `
      <div class="border rounded-md mt-4">
        <div class="section-header p-2 bg-blue-50 hover:bg-blue-100" onclick="toggleAccordion(this)">
          <h5 class="font-semibold text-sm text-blue-800">Cuestionario: Problem Areas in Diabetes (PAID)</h5>
          <svg class="w-5 h-5 transform transition-transform text-blue-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </div>
        <div class="p-3 hidden text-xs">
          <div class="space-y-2">
            <label class="form-label block">¿Sigue el plan de alimentación?</label> <select name="app_paid_q1" class="form-select text-xs" data-list="frecuencia_paid"></select>
            <label class="form-label block">¿Controla porciones de carbohidratos?</label> <select name="app_paid_q2" class="form-select text-xs" data-list="frecuencia_paid"></select>
            <label class="form-label block">¿Registra consumo y glucosa?</label> <select name="app_paid_q3" class="form-select text-xs" data-list="frecuencia_paid"></select>
            <label class="form-label block">¿Realiza actividad física acordada?</label> <select name="app_paid_q4" class="form-select text-xs" data-list="frecuencia_paid"></select>
            <label class="form-label block">¿Revisa sus pies diariamente?</label> <select name="app_paid_q5" class="form-select text-xs" data-list="frecuencia_paid"></select>
            <label class="form-label block">¿Toma medicamentos/insulina según indicaciones?</label> <select name="app_paid_q6" class="form-select text-xs" data-list="frecuencia_paid"></select>
            <label class="form-label block">¿Su familia/amigos le apoyan?</label> <select name="app_paid_q7" class="form-select text-xs" data-list="frecuencia_paid"></select>
            <label class="form-label block">¿Asiste a grupos de educación o seguimiento?</label> <select name="app_paid_q8" class="form-select text-xs" data-list="frecuencia_paid"></select>
            <label class="form-label block mt-2">Interpretación:</label>
            <textarea name="app_paid_interpretacion" class="form-textarea" rows="2"></textarea>
          </div>
        </div>
      </div>`,
    ibss: `
      <div class="border rounded-md mt-4">
        <div class="section-header p-2 bg-blue-50 hover:bg-blue-100" onclick="toggleAccordion(this)">
          <h5 class="font-semibold text-sm text-blue-800">Cuestionario: Síndrome de Intestino Irritable (IBSS)</h5>
          <svg class="w-5 h-5 transform transition-transform text-blue-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </div>
        <div class="p-3 hidden text-xs">
          <div class="space-y-2">
            <label class="form-label block">¿Sufre frecuentemente dolor abdominal?</label> <select name="app_ibss_q1" class="form-select text-xs" data-list="frecuencia_ibss"></select>
            <label class="form-label block">¿Cuántos días tuvo dolor la última semana?</label> <input type="number" name="app_ibss_q2" class="form-input text-xs">
            <label class="form-label block">¿Impacto en actividades cotidianas?</label> <select name="app_ibss_q3" class="form-select text-xs" data-list="impacto_ibss"></select>
            <label class="form-label block">¿Satisfecho con su hábito intestinal?</label> <select name="app_ibss_q4" class="form-select text-xs" data-list="satisfaccion_ibss"></select>
            <label class="form-label block mt-2">Puntaje total:</label> <input type="text" name="app_ibss_score" class="form-input bg-gray-200" readonly>
            <label class="form-label block mt-2">Interpretación:</label> <textarea name="app_ibss_interpretacion" class="form-textarea" rows="2"></textarea>
          </div>
        </div>
      </div>`,
    psq: `
      <!-- GAD-7 -->
      <div class="border rounded-md mt-4">
        <div class="section-header p-2 bg-yellow-50 hover:bg-yellow-100" onclick="toggleAccordion(this)">
          <h5 class="font-semibold text-sm text-yellow-800">Cuestionario de Ansiedad (GAD-7)</h5>
          <svg class="w-5 h-5 transform transition-transform text-yellow-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </div>
        <div class="p-3 hidden text-xs">
          <div class="space-y-2">
            <label class="form-label block">Sentirse nervioso, ansioso o tenso</label> <select name="app_gad7_q1" class="form-select text-xs" data-list="frecuencia_gad7_phq9"></select>
            <label class="form-label block">No poder dejar de preocuparse</label> <select name="app_gad7_q2" class="form-select text-xs" data-list="frecuencia_gad7_phq9"></select>
            <label class="form-label block">Preocuparse demasiado</label> <select name="app_gad7_q3" class="form-select text-xs" data-list="frecuencia_gad7_phq9"></select>
            <label class="form-label block">Problemas para relajarse</label> <select name="app_gad7_q4" class="form-select text-xs" data-list="frecuencia_gad7_phq9"></select>
            <label class="form-label block">Estar tan inquieto que es difícil quedarse sentado</label> <select name="app_gad7_q5" class="form-select text-xs" data-list="frecuencia_gad7_phq9"></select>
            <label class="form-label block">Enfadarse o irritarse con facilidad</label> <select name="app_gad7_q6" class="form-select text-xs" data-list="frecuencia_gad7_phq9"></select>
            <label class="form-label block">Sentir miedo de que algo terrible pueda ocurrir</label> <select name="app_gad7_q7" class="form-select text-xs" data-list="frecuencia_gad7_phq9"></select>
            <label class="form-label block mt-2">Puntuación:</label> <input type="text" name="app_gad7_score" class="form-input bg-gray-200" readonly>
            <label class="form-label block mt-2">Interpretación:</label> <textarea name="app_gad7_interpretacion" class="form-textarea" rows="2"></textarea>
          </div>
        </div>
      </div>
      <!-- PHQ-9 -->
      <div class="border rounded-md mt-4">
        <div class="section-header p-2 bg-yellow-50 hover:bg-yellow-100" onclick="toggleAccordion(this)">
          <h5 class="font-semibold text-sm text-yellow-800">Cuestionario de Depresión (PHQ-9)</h5>
          <svg class="w-5 h-5 transform transition-transform text-yellow-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </div>
        <div class="p-3 hidden text-xs">
          <div class="space-y-2">
            <label class="form-label block">Poco interés o alegría</label> <select name="app_phq9_q1" class="form-select text-xs" data-list="frecuencia_gad7_phq9"></select>
            <label class="form-label block">Decaído, deprimido o desesperanzado</label> <select name="app_phq9_q2" class="form-select text-xs" data-list="frecuencia_gad7_phq9"></select>
            <label class="form-label block">Problemas para dormir</label> <select name="app_phq9_q3" class="form-select text-xs" data-list="frecuencia_gad7_phq9"></select>
            <label class="form-label block">Cansancio o poca energía</label> <select name="app_phq9_q4" class="form-select text-xs" data-list="frecuencia_gad7_phq9"></select>
            <label class="form-label block">Poco apetito o comer demasiado</label> <select name="app_phq9_q5" class="form-select text-xs" data-list="frecuencia_gad7_phq9"></select>
            <label class="form-label block">Sentirse mal consigo mismo</label> <select name="app_phq9_q6" class="form-select text-xs" data-list="frecuencia_gad7_phq9"></select>
            <label class="form-label block">Problemas para concentrarse</label> <select name="app_phq9_q7" class="form-select text-xs" data-list="frecuencia_gad7_phq9"></select>
            <label class="form-label block">Moverse o hablar lento, o estar inquieto</label> <select name="app_phq9_q8" class="form-select text-xs" data-list="frecuencia_gad7_phq9"></select>
            <label class="form-label block">Pensamientos de querer hacerse daño</label> <select name="app_phq9_q9" class="form-select text-xs" data-list="frecuencia_gad7_phq9"></select>
            <label class="form-label block mt-2">Puntuación:</label> <input type="text" name="app_phq9_score" class="form-input bg-gray-200" readonly>
            <label class="form-label block mt-2">Interpretación:</label> <textarea name="app_phq9_interpretacion" class="form-textarea" rows="2"></textarea>
          </div>
        </div>
      </div>
      <!-- Yesavage -->
      <div class="border rounded-md mt-4">
         <div class="section-header p-2 bg-yellow-50 hover:bg-yellow-100" onclick="toggleAccordion(this)">
            <h5 class="font-semibold text-sm text-yellow-800">Escala de Depresión Geriátrica (GDS-15)</h5>
            <svg class="w-5 h-5 transform transition-transform text-yellow-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
         </div>
         <div class="p-3 hidden text-xs"> <div class="space-y-2">
            <label class="form-label block">¿Está satisfecho con su vida?</label> <select name="app_gds15_q1" class="form-select text-xs" data-list="opciones_binarias"></select>
            <label class="form-label block">¿Ha abandonado actividades?</label> <select name="app_gds15_q2" class="form-select text-xs" data-list="opciones_binarias"></select>
            <label class="form-label block">¿Siente que su vida está vacía?</label> <select name="app_gds15_q3" class="form-select text-xs" data-list="opciones_binarias"></select>
            <label class="form-label block">¿Se encuentra aburrido?</label> <select name="app_gds15_q4" class="form-select text-xs" data-list="opciones_binarias"></select>
            <label class="form-label block">¿Está alegre la mayor parte del tiempo?</label> <select name="app_gds15_q5" class="form-select text-xs" data-list="opciones_binarias"></select>
            <label class="form-label block">¿Teme que le suceda algo malo?</label> <select name="app_gds15_q6" class="form-select text-xs" data-list="opciones_binarias"></select>
            <label class="form-label block">¿Se siente feliz la mayor parte del tiempo?</label> <select name="app_gds15_q7" class="form-select text-xs" data-list="opciones_binarias"></select>
            <label class="form-label block">¿Se siente desamparado?</label> <select name="app_gds15_q8" class="form-select text-xs" data-list="opciones_binarias"></select>
            <label class="form-label block">¿Prefiere quedarse en casa?</label> <select name="app_gds15_q9" class="form-select text-xs" data-list="opciones_binarias"></select>
            <label class="form-label block">¿Siente que tiene más problemas de memoria?</label> <select name="app_gds15_q10" class="form-select text-xs" data-list="opciones_binarias"></select>
            <label class="form-label block">¿Piensa que es maravilloso estar vivo?</label> <select name="app_gds15_q11" class="form-select text-xs" data-list="opciones_binarias"></select>
            <label class="form-label block">¿Se siente inútil o despreciable?</label> <select name="app_gds15_q12" class="form-select text-xs" data-list="opciones_binarias"></select>
            <label class="form-label block">¿Se siente lleno de energía?</label> <select name="app_gds15_q13" class="form-select text-xs" data-list="opciones_binarias"></select>
            <label class="form-label block">¿Se encuentra sin esperanza?</label> <select name="app_gds15_q14" class="form-select text-xs" data-list="opciones_binarias"></select>
            <label class="form-label block">¿Piensa que la mayoría está mejor?</label> <select name="app_gds15_q15" class="form-select text-xs" data-list="opciones_binarias"></select>
            <label class="form-label block mt-2">Puntuación:</label> <input type="text" name="app_gds15_score" class="form-input bg-gray-200" readonly>
            <label class="form-label block mt-2">Interpretación:</label> <textarea name="app_gds15_interpretacion" class="form-textarea" rows="2"></textarea>
         </div></div>
      </div>`
  };
  
  // --- Generador de HTML ---
  chronicDiseasesConfig.forEach(system => {
    let diseasesHtml = '';
    system.diseases.forEach(disease => {
      // Campos de detalle de la enfermedad
      let detailFields = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-3">
          ${disease.isOther ? `<div class="md:col-span-3"><label class="form-label">Especificar</label><textarea name="app_${disease.id}_especificar" class="form-textarea" rows="1"></textarea></div>` : ''}
          <div><label class="form-label">Edad/Año de diagnóstico</label><input type="text" name="app_${disease.id}_dx_edad" class="form-input"></div>
          <div><label class="form-label">Tratamientos previos</label><input type="text" name="app_${disease.id}_tx_previo" class="form-input"></div>
          <div><label class="form-label">Tratamiento actual</label><input type="text" name="app_${disease.id}_tx_actual" class="form-input"></div>
          <div class="md:col-span-2"><label class="form-label">Evolución</label><input type="text" name="app_${disease.id}_evolucion" class="form-input"></div>
          <div><label class="form-label">Complicaciones</label><input type="text" name="app_${disease.id}_complicaciones" class="form-input"></div>
        </div>
        ${disease.questionnaire ? questionnairesHTML[disease.questionnaire] || '' : ''}
      `;
      
      let subDiseasesHtml = '';
      if(disease.subDiseases) {
          subDiseasesHtml = disease.subDiseases.map(sub => `
             <div class="pl-4">
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" name="app_${sub.toLowerCase()}_presente" class="form-checkbox h-4 w-4 text-cyan-500 rounded">
                    <span class="font-normal text-gray-600">${sub}</span>
                </label>
            </div>
          `).join('');
      }

      diseasesHtml += `
        <div class="disease-row border-t pt-3">
          <label class="flex items-center space-x-3 cursor-pointer">
            <input type="checkbox" name="app_${disease.id}_presente" class="form-checkbox h-5 w-5 text-cyan-600 rounded" onclick="toggleContent(this)">
            <span class="font-medium text-gray-800">${disease.name}</span>
          </label>
          ${subDiseasesHtml}
          <div class="disease-details hidden pl-8 pt-2">
            ${detailFields}
          </div>
        </div>`;
    });

    html += `
      <div class="border rounded-md">
        <div class="section-header p-2 bg-gray-50 hover:bg-gray-100" onclick="toggleAccordion(this)">
          <h4 class="font-semibold text-gray-700">${system.name}</h4>
          <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </div>
        <div class="p-4 hidden">
          <div class="space-y-4">
            ${diseasesHtml}
          </div>
        </div>
      </div>`;
  });

  // Inyectar el HTML generado en el contenedor.
  if(container) {
    container.innerHTML = html;
  }
</script>
